"use strict";(self.webpackChunkfilebridge_docs=self.webpackChunkfilebridge_docs||[]).push([[334],{1442(e,s,n){n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>c,default:()=>a,frontMatter:()=>t,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"Architecture","title":"Architecture","description":"This document describes FileBridge\'s system architecture, component interactions, data models, and key design decisions.","source":"@site/../docs/Architecture.md","sourceDirName":".","slug":"/Architecture","permalink":"/FileBridge/docs/Architecture","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"API Reference","permalink":"/FileBridge/docs/API-Reference"},"next":{"title":"Security","permalink":"/FileBridge/docs/Security"}}');var i=n(4848),d=n(8453);const t={},c="Architecture",l={},o=[{value:"High-Level Overview",id:"high-level-overview",level:2},{value:"Request Lifecycle",id:"request-lifecycle",level:2},{value:"Browser \u2192 API Request",id:"browser--api-request",level:3},{value:"Scheduler \u2192 Transfer Engine",id:"scheduler--transfer-engine",level:3},{value:"Project Structure",id:"project-structure",level:2},{value:"Database Schema",id:"database-schema",level:2},{value:"<code>connections</code>",id:"connections",level:3},{value:"<code>jobs</code>",id:"jobs",level:3},{value:"<code>job_runs</code>",id:"job_runs",level:3},{value:"<code>transfer_logs</code>",id:"transfer_logs",level:3},{value:"<code>settings</code>",id:"settings",level:3},{value:"<code>audit_logs</code>",id:"audit_logs",level:3},{value:"Database Indexes",id:"database-indexes",level:3},{value:"Storage Provider Interface",id:"storage-provider-interface",level:2},{value:"Scheduler Architecture",id:"scheduler-architecture",level:2},{value:"Key Design Decisions",id:"key-design-decisions",level:2},{value:"Why SQLite?",id:"why-sqlite",level:3},{value:"Why In-Process Scheduler?",id:"why-in-process-scheduler",level:3},{value:"Why Next.js?",id:"why-nextjs",level:3},{value:"Buffer-Based File Transfer",id:"buffer-based-file-transfer",level:3}];function h(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"architecture",children:"Architecture"})}),"\n",(0,i.jsx)(s.p,{children:"This document describes FileBridge's system architecture, component interactions, data models, and key design decisions."}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"high-level-overview",children:"High-Level Overview"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502          Browser (React)             \u2502\n                    \u2502  Dashboard \u2502 Jobs \u2502 Connections \u2502 \u2026  \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                       \u2502 TanStack Query (HTTP/JSON)\n                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502       Next.js API Routes             \u2502\n                    \u2502   /api/jobs  /api/connections  \u2026     \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                           \u2502               \u2502\n              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n              \u2502 SQLite (Drizzle)\u2502   \u2502     Storage Providers      \u2502\n              \u2502 jobs, runs, logs\u2502   \u2502  SFTP \u2502 SMB \u2502 Azure Blob   \u2502\n              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                           \u2502\n              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n              \u2502   Scheduler (node-cron)     \u2502\n              \u2502   \u2192 Transfer Engine         \u2502\n              \u2502   \u2192 Audit Logging           \u2502\n              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsxs)(s.p,{children:["FileBridge is a ",(0,i.jsx)(s.strong,{children:"monolithic Next.js application"})," \u2014 the UI, API, scheduler, and transfer engine all run in the same Node.js process. This keeps deployment simple (single container, single port) at the cost of limiting horizontal scalability (which is on the roadmap via Redis-backed queues)."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"request-lifecycle",children:"Request Lifecycle"}),"\n",(0,i.jsx)(s.h3,{id:"browser--api-request",children:"Browser \u2192 API Request"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsx)(s.li,{children:"Browser sends an HTTP request (via TanStack Query)"}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"proxy.ts"})," runs (Node.js runtime):","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Generates or propagates ",(0,i.jsx)(s.code,{children:"X-Request-ID"})," UUID"]}),"\n",(0,i.jsx)(s.li,{children:"Validates the NextAuth session JWT"}),"\n",(0,i.jsxs)(s.li,{children:["Redirects to ",(0,i.jsx)(s.code,{children:"/login"})," if unauthenticated"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.li,{children:"The matching Next.js API route handler runs (Node.js runtime)"}),"\n",(0,i.jsx)(s.li,{children:"Handler reads/writes the SQLite database via Drizzle ORM"}),"\n",(0,i.jsx)(s.li,{children:"Handler may interact with storage providers (for connection testing, file browsing)"}),"\n",(0,i.jsx)(s.li,{children:"Handler logs an audit event if the action is auditable"}),"\n",(0,i.jsx)(s.li,{children:"Response is returned as JSON"}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"scheduler--transfer-engine",children:"Scheduler \u2192 Transfer Engine"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["At server startup, ",(0,i.jsx)(s.code,{children:"instrumentation.ts"})," calls ",(0,i.jsx)(s.code,{children:"initializeScheduler()"})," and ",(0,i.jsx)(s.code,{children:"initializeBackupScheduler()"})]}),"\n",(0,i.jsxs)(s.li,{children:["The scheduler queries the DB for all ",(0,i.jsx)(s.code,{children:"active"})," jobs and registers a ",(0,i.jsx)(s.code,{children:"node-cron"})," task for each"]}),"\n",(0,i.jsx)(s.li,{children:"When a cron trigger fires, the task re-checks the job's status in the DB (guard against stale in-memory state)"}),"\n",(0,i.jsxs)(s.li,{children:["If still active, ",(0,i.jsx)(s.code,{children:"runJob(jobId)"})," is called on the transfer engine"]}),"\n",(0,i.jsxs)(s.li,{children:["The engine runs the full transfer flow (see ",(0,i.jsx)(s.a,{href:"Transfer-Engine",children:"Transfer Engine"}),")"]}),"\n",(0,i.jsxs)(s.li,{children:["Results are written to ",(0,i.jsx)(s.code,{children:"job_runs"})," and ",(0,i.jsx)(s.code,{children:"transfer_logs"})]}),"\n",(0,i.jsx)(s.li,{children:"The scheduler writes an audit event for the execution"}),"\n"]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"project-structure",children:"Project Structure"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"app/\n\u251c\u2500\u2500 page.tsx                          # Redirects to /dashboard\n\u251c\u2500\u2500 layout.tsx                        # Root layout (TanStack Query provider, theme, fonts)\n\u251c\u2500\u2500 (dashboard)/\n\u2502   \u251c\u2500\u2500 layout.tsx                    # Sidebar + AuthGuard wrapper\n\u2502   \u251c\u2500\u2500 dashboard/page.tsx            # KPIs, charts, activity feed\n\u2502   \u251c\u2500\u2500 connections/page.tsx          # Connection management\n\u2502   \u251c\u2500\u2500 jobs/page.tsx                 # Job management\n\u2502   \u251c\u2500\u2500 logs/page.tsx                 # Transfer audit log\n\u2502   \u251c\u2500\u2500 audit-logs/page.tsx           # Security audit log\n\u2502   \u2514\u2500\u2500 settings/page.tsx            # Notification + backup + timezone settings\n\u2514\u2500\u2500 api/\n    \u251c\u2500\u2500 auth/[...nextauth]/route.ts   # NextAuth handlers\n    \u251c\u2500\u2500 connections/                   # CRUD, test, browse, mkdir, file ops\n    \u251c\u2500\u2500 jobs/                         # CRUD, run, dry-run, run history\n    \u251c\u2500\u2500 logs/route.ts                 # Paginated transfer logs\n    \u251c\u2500\u2500 audit-logs/route.ts           # Paginated audit logs\n    \u251c\u2500\u2500 dashboard/stats/route.ts      # KPI + chart data\n    \u251c\u2500\u2500 settings/route.ts             # Notification config\n    \u251c\u2500\u2500 settings/timezone/route.ts    # Timezone config (GET + POST)\n    \u251c\u2500\u2500 backup/                       # run, list, restore\n    \u2514\u2500\u2500 health/route.ts               # Liveness/readiness probe\n\ncomponents/\n\u251c\u2500\u2500 auth-guard.tsx                    # Auth wrapper with dev bypass\n\u251c\u2500\u2500 sidebar.tsx                       # Navigation sidebar\n\u251c\u2500\u2500 providers.tsx                     # TanStack Query + theme providers\n\u251c\u2500\u2500 connections/                      # ConnectionList, ConnectionForm\n\u251c\u2500\u2500 jobs/                             # JobList, JobForm, JobDetailSheet (with logs panel)\n\u251c\u2500\u2500 logs/                             # LogTable\n\u251c\u2500\u2500 audit-logs/                       # AuditLogTable\n\u251c\u2500\u2500 dashboard/                        # StatsCards, TransferChart, ActivityFeed, JobStatusList\n\u251c\u2500\u2500 settings/                         # NotificationSettings, BackupSettings, TimezoneSettings\n\u2514\u2500\u2500 ui/                               # shadcn/ui primitives + FileBrowserDialog\n\nlib/\n\u251c\u2500\u2500 auth/                             # NextAuth config + session helpers\n\u2502   \u251c\u2500\u2500 config.ts                     # Shared callbacks, session strategy, cookie config\n\u2502   \u2514\u2500\u2500 index.ts                      # Full auth export (providers, DB, SSO)\n\u251c\u2500\u2500 db/\n\u2502   \u251c\u2500\u2500 schema.ts                     # Drizzle table definitions + TypeScript types\n\u2502   \u2514\u2500\u2500 index.ts                      # SQLite connection + schema init\n\u251c\u2500\u2500 storage/\n\u2502   \u251c\u2500\u2500 interface.ts                  # StorageProvider interface, FileInfo type, globToRegex\n\u2502   \u251c\u2500\u2500 sftp.ts                       # SSH2 SFTP implementation\n\u2502   \u251c\u2500\u2500 smb.ts                        # v9u-smb2 NTLMv2 implementation\n\u2502   \u251c\u2500\u2500 azure-blob.ts                 # @azure/storage-blob implementation\n\u2502   \u251c\u2500\u2500 local.ts                      # Local filesystem implementation\n\u2502   \u2514\u2500\u2500 registry.ts                   # Provider factory (protocol \u2192 class)\n\u251c\u2500\u2500 transfer/\n\u2502   \u2514\u2500\u2500 engine.ts                     # Core transfer orchestration + dry run\n\u251c\u2500\u2500 scheduler/\n\u2502   \u2514\u2500\u2500 index.ts                      # node-cron job scheduling (timezone-aware)\n\u251c\u2500\u2500 backup/\n\u2502   \u2514\u2500\u2500 index.ts                      # SQLite backup, restore, pruning\n\u251c\u2500\u2500 audit.ts                          # Audit log writer, diffChanges, IP extraction\n\u251c\u2500\u2500 logger.ts                         # pino structured logger + context propagation\n\u251c\u2500\u2500 env.ts                            # Zod env validation (fail-fast startup)\n\u2514\u2500\u2500 utils.ts                          # Shared utilities (cn, etc.)\n\nproxy.ts                              # Auth + request ID injection (Node.js runtime)\ninstrumentation.ts                    # Scheduler init on Node.js server startup\n"})}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"database-schema",children:"Database Schema"}),"\n",(0,i.jsx)(s.p,{children:"FileBridge uses a SQLite database managed by Drizzle ORM. The schema auto-initializes on startup."}),"\n",(0,i.jsx)(s.h3,{id:"connections",children:(0,i.jsx)(s.code,{children:"connections"})}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Column"}),(0,i.jsx)(s.th,{children:"Type"}),(0,i.jsx)(s.th,{children:"Description"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"id"})}),(0,i.jsx)(s.td,{children:"INTEGER PK"}),(0,i.jsx)(s.td,{children:"Auto-increment"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"name"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Display name"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"protocol"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"sftp"}),", ",(0,i.jsx)(s.code,{children:"smb"}),", ",(0,i.jsx)(s.code,{children:"azure-blob"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"host"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Server hostname or IP"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"port"})}),(0,i.jsx)(s.td,{children:"INTEGER"}),(0,i.jsx)(s.td,{children:"Server port"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"credentials"})}),(0,i.jsx)(s.td,{children:"TEXT (JSON)"}),(0,i.jsx)(s.td,{children:"Auth credentials \u2014 never returned in list APIs"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"created_at"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"ISO timestamp"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"updated_at"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"ISO timestamp"})]})]})]}),"\n",(0,i.jsx)(s.h3,{id:"jobs",children:(0,i.jsx)(s.code,{children:"jobs"})}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Column"}),(0,i.jsx)(s.th,{children:"Type"}),(0,i.jsx)(s.th,{children:"Description"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"id"})}),(0,i.jsx)(s.td,{children:"INTEGER PK"}),(0,i.jsx)(s.td,{children:"Auto-increment"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"name"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Display name"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"source_connection_id"})}),(0,i.jsx)(s.td,{children:"INTEGER FK"}),(0,i.jsxs)(s.td,{children:["References ",(0,i.jsx)(s.code,{children:"connections.id"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"source_path"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Remote path to read from"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"destination_connection_id"})}),(0,i.jsx)(s.td,{children:"INTEGER FK"}),(0,i.jsxs)(s.td,{children:["References ",(0,i.jsx)(s.code,{children:"connections.id"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"destination_path"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Remote path to write to"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"file_filter"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Glob pattern (empty = all)"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"schedule"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Cron expression"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"post_transfer_action"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"retain"}),", ",(0,i.jsx)(s.code,{children:"delete"}),", ",(0,i.jsx)(s.code,{children:"move"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"move_path"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsxs)(s.td,{children:["Target path when action is ",(0,i.jsx)(s.code,{children:"move"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"overwrite_existing"})}),(0,i.jsx)(s.td,{children:"INTEGER (bool)"}),(0,i.jsx)(s.td,{children:"Default false"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"skip_hidden_files"})}),(0,i.jsx)(s.td,{children:"INTEGER (bool)"}),(0,i.jsx)(s.td,{children:"Default true"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"extract_archives"})}),(0,i.jsx)(s.td,{children:"INTEGER (bool)"}),(0,i.jsx)(s.td,{children:"Default false"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"delta_sync"})}),(0,i.jsx)(s.td,{children:"INTEGER (bool)"}),(0,i.jsx)(s.td,{children:"Default false"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"status"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"active"}),", ",(0,i.jsx)(s.code,{children:"inactive"}),", ",(0,i.jsx)(s.code,{children:"running"}),", ",(0,i.jsx)(s.code,{children:"error"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"last_run_at"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"ISO timestamp"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"next_run_at"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"ISO timestamp"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"created_at"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"ISO timestamp"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"updated_at"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"ISO timestamp"})]})]})]}),"\n",(0,i.jsx)(s.h3,{id:"job_runs",children:(0,i.jsx)(s.code,{children:"job_runs"})}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Column"}),(0,i.jsx)(s.th,{children:"Type"}),(0,i.jsx)(s.th,{children:"Description"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"id"})}),(0,i.jsx)(s.td,{children:"INTEGER PK"}),(0,i.jsx)(s.td,{children:"Auto-increment"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"job_id"})}),(0,i.jsx)(s.td,{children:"INTEGER FK"}),(0,i.jsxs)(s.td,{children:["References ",(0,i.jsx)(s.code,{children:"jobs.id"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"started_at"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"ISO timestamp"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"completed_at"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"ISO timestamp (null while running)"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"status"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"running"}),", ",(0,i.jsx)(s.code,{children:"success"}),", ",(0,i.jsx)(s.code,{children:"failure"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"error_message"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Set on failure"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"files_transferred"})}),(0,i.jsx)(s.td,{children:"INTEGER"}),(0,i.jsx)(s.td,{children:"Incremented in real time"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"bytes_transferred"})}),(0,i.jsx)(s.td,{children:"INTEGER"}),(0,i.jsx)(s.td,{children:"Incremented in real time"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"total_files"})}),(0,i.jsx)(s.td,{children:"INTEGER"}),(0,i.jsx)(s.td,{children:"Set after listing (for progress %)"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"current_file"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Updated per-file (for live progress)"})]})]})]}),"\n",(0,i.jsx)(s.h3,{id:"transfer_logs",children:(0,i.jsx)(s.code,{children:"transfer_logs"})}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Column"}),(0,i.jsx)(s.th,{children:"Type"}),(0,i.jsx)(s.th,{children:"Description"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"id"})}),(0,i.jsx)(s.td,{children:"INTEGER PK"}),(0,i.jsx)(s.td,{children:"Auto-increment"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"job_id"})}),(0,i.jsx)(s.td,{children:"INTEGER FK"}),(0,i.jsxs)(s.td,{children:["References ",(0,i.jsx)(s.code,{children:"jobs.id"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"job_run_id"})}),(0,i.jsx)(s.td,{children:"INTEGER FK"}),(0,i.jsxs)(s.td,{children:["References ",(0,i.jsx)(s.code,{children:"job_runs.id"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"file_name"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"File name only"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"source_path"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Full source path"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"destination_path"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Full destination path"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"file_size"})}),(0,i.jsx)(s.td,{children:"INTEGER"}),(0,i.jsx)(s.td,{children:"Bytes"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"transferred_at"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"ISO timestamp"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"status"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"success"}),", ",(0,i.jsx)(s.code,{children:"failure"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"error_message"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Set on failure"})]})]})]}),"\n",(0,i.jsx)(s.h3,{id:"settings",children:(0,i.jsx)(s.code,{children:"settings"})}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Column"}),(0,i.jsx)(s.th,{children:"Type"}),(0,i.jsx)(s.th,{children:"Description"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"id"})}),(0,i.jsx)(s.td,{children:"INTEGER PK"}),(0,i.jsx)(s.td,{children:"Auto-increment"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"key"})}),(0,i.jsx)(s.td,{children:"TEXT UNIQUE"}),(0,i.jsxs)(s.td,{children:["Setting name (e.g. ",(0,i.jsx)(s.code,{children:"notifications"}),", ",(0,i.jsx)(s.code,{children:"backup"}),")"]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"value"})}),(0,i.jsx)(s.td,{children:"TEXT (JSON)"}),(0,i.jsx)(s.td,{children:"Setting value as JSON"})]})]})]}),"\n",(0,i.jsx)(s.h3,{id:"audit_logs",children:(0,i.jsx)(s.code,{children:"audit_logs"})}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Column"}),(0,i.jsx)(s.th,{children:"Type"}),(0,i.jsx)(s.th,{children:"Description"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"id"})}),(0,i.jsx)(s.td,{children:"INTEGER PK"}),(0,i.jsx)(s.td,{children:"Auto-increment"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"user_id"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsxs)(s.td,{children:["User email or ",(0,i.jsx)(s.code,{children:'"scheduler"'})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"action"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"create"}),", ",(0,i.jsx)(s.code,{children:"update"}),", ",(0,i.jsx)(s.code,{children:"delete"}),", ",(0,i.jsx)(s.code,{children:"execute"}),", ",(0,i.jsx)(s.code,{children:"login"}),", ",(0,i.jsx)(s.code,{children:"settings_change"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"resource"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"connection"}),", ",(0,i.jsx)(s.code,{children:"job"}),", ",(0,i.jsx)(s.code,{children:"settings"}),", ",(0,i.jsx)(s.code,{children:"job_run"}),", ",(0,i.jsx)(s.code,{children:"auth"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"resource_id"})}),(0,i.jsx)(s.td,{children:"INTEGER"}),(0,i.jsx)(s.td,{children:"ID of the affected record"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"resource_name"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Human-readable name"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"ip_address"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"Client IP"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"details"})}),(0,i.jsx)(s.td,{children:"TEXT (JSON)"}),(0,i.jsx)(s.td,{children:"Structured context"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"timestamp"})}),(0,i.jsx)(s.td,{children:"TEXT"}),(0,i.jsx)(s.td,{children:"ISO timestamp"})]})]})]}),"\n",(0,i.jsx)(s.h3,{id:"database-indexes",children:"Database Indexes"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"-- Performance indexes added for common query patterns\nCREATE INDEX transfer_logs_job_id     ON transfer_logs(job_id);\nCREATE INDEX transfer_logs_status     ON transfer_logs(status);\nCREATE INDEX transfer_logs_time       ON transfer_logs(transferred_at);\nCREATE INDEX transfer_logs_run_status ON transfer_logs(job_run_id, status);\nCREATE INDEX jobs_status              ON jobs(status);\nCREATE INDEX job_runs_job_id          ON job_runs(job_id);\nCREATE INDEX audit_logs_timestamp     ON audit_logs(timestamp);\nCREATE INDEX audit_logs_user_id       ON audit_logs(user_id);\nCREATE INDEX audit_logs_resource      ON audit_logs(resource);\n"})}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"storage-provider-interface",children:"Storage Provider Interface"}),"\n",(0,i.jsxs)(s.p,{children:["All storage backends implement a common interface (",(0,i.jsx)(s.code,{children:"lib/storage/interface.ts"}),"):"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"interface StorageProvider {\n  connect(): Promise<void>\n  disconnect(): Promise<void>\n  listFiles(path: string, filter?: string): Promise<FileInfo[]>\n  listDirectory(path: string): Promise<FileInfo[]>\n  downloadFile(remotePath: string): Promise<Buffer>\n  uploadFile(content: Buffer, remotePath: string): Promise<void>\n  deleteFile(remotePath: string): Promise<void>\n  moveFile(sourcePath: string, destinationPath: string): Promise<void>\n  createDirectory(path: string): Promise<void>\n}\n\ninterface FileInfo {\n  name: string\n  size: number\n  modifiedAt: Date\n  isDirectory: boolean\n}\n"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"listFiles"})," applies the glob filter and returns only files (no directories)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"listDirectory"})," returns everything (files + directories) for the UI file browser"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"createDirectory"})," creates a new directory at the given path (used by the file browser and API)"]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["The provider factory in ",(0,i.jsx)(s.code,{children:"lib/storage/registry.ts"})," maps protocol names to concrete classes."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"scheduler-architecture",children:"Scheduler Architecture"}),"\n",(0,i.jsxs)(s.p,{children:["The scheduler (",(0,i.jsx)(s.code,{children:"lib/scheduler/index.ts"}),") maintains an in-memory ",(0,i.jsx)(s.code,{children:"Map<jobId, ScheduledTask>"}),". This map is initialized at startup by ",(0,i.jsx)(s.code,{children:"instrumentation.ts"})," and mutated by API routes when jobs are created, updated, or deleted."]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Timezone-aware scheduling"}),": All cron tasks run in the timezone stored in the ",(0,i.jsx)(s.code,{children:"settings"})," table under the key ",(0,i.jsx)(s.code,{children:'"timezone"'})," (defaults to ",(0,i.jsx)(s.code,{children:'"UTC"'}),"). The timezone is read at initialization and applied to every ",(0,i.jsx)(s.code,{children:"node-cron"})," task. When the timezone is changed via the settings API, ",(0,i.jsx)(s.code,{children:"rescheduleAllJobs()"})," is called to rebuild all active tasks with the new timezone."]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Startup recovery"}),": On init, any jobs with ",(0,i.jsx)(s.code,{children:'status = "running"'})," (left over from a crashed process) are reset to ",(0,i.jsx)(s.code,{children:'"error"'}),"."]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Re-check on trigger"}),": When a cron task fires, it re-reads the job from the database before running. This guards against stale state in Next.js's module cache, where an API route might have updated the job status in a different module instance."]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Exported helpers"}),":"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"scheduleJob(jobId, cronExpression)"})," \u2014 schedule or reschedule a single job (reads timezone from DB)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"unscheduleJob(jobId)"})," \u2014 remove a job from the scheduler"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"rescheduleAllJobs()"})," \u2014 rebuild all active job tasks (called after timezone change)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"getSchedulerTimezone()"})," \u2014 read the current timezone from the ",(0,i.jsx)(s.code,{children:"settings"})," table"]}),"\n"]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"key-design-decisions",children:"Key Design Decisions"}),"\n",(0,i.jsx)(s.h3,{id:"why-sqlite",children:"Why SQLite?"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Zero infrastructure \u2014 no separate database server to manage"}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"better-sqlite3"})," is synchronous, which simplifies the code significantly"]}),"\n",(0,i.jsx)(s.li,{children:"The online backup API provides safe, consistent snapshots without downtime"}),"\n",(0,i.jsx)(s.li,{children:"For most file transfer workloads, SQLite's concurrency limits are not a bottleneck (jobs run sequentially within each cron slot)"}),"\n",(0,i.jsx)(s.li,{children:"Migration path to PostgreSQL is on the roadmap for multi-instance deployments"}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"why-in-process-scheduler",children:"Why In-Process Scheduler?"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"No external queue infrastructure (Redis, RabbitMQ) needed"}),"\n",(0,i.jsx)(s.li,{children:"Simple deployment as a single container"}),"\n",(0,i.jsx)(s.li,{children:"Works perfectly for single-instance deployments"}),"\n",(0,i.jsx)(s.li,{children:"The downside is that horizontal scaling requires a distributed scheduler \u2014 planned via BullMQ + Redis"}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"why-nextjs",children:"Why Next.js?"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Unified codebase for UI and API \u2014 no separate backend service"}),"\n",(0,i.jsx)(s.li,{children:"App Router + TypeScript for strong typing throughout"}),"\n",(0,i.jsx)(s.li,{children:"Server Components for fast initial loads"}),"\n",(0,i.jsx)(s.li,{children:"Standalone output mode makes Docker images small and self-contained"}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"buffer-based-file-transfer",children:"Buffer-Based File Transfer"}),"\n",(0,i.jsxs)(s.p,{children:["The current implementation downloads entire files into memory (",(0,i.jsx)(s.code,{children:"Buffer"}),") before uploading. This is simple and works well for typical file sizes (KB to tens of MB). For very large files (hundreds of MB to GB), streaming transfers (piping source stream directly to destination) are planned to avoid memory pressure."]})]})}function a(e={}){const{wrapper:s}={...(0,d.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},8453(e,s,n){n.d(s,{R:()=>t,x:()=>c});var r=n(6540);const i={},d=r.createContext(i);function t(e){const s=r.useContext(d);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),r.createElement(d.Provider,{value:s},e.children)}}}]);