"use strict";(self.webpackChunkfilebridge_docs=self.webpackChunkfilebridge_docs||[]).push([[276],{3981(e,n,r){r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>a,frontMatter:()=>d,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"Structured-Logging","title":"Structured Logging","description":"FileBridge emits structured JSON logs using pino, a high-performance Node.js logger. All log output goes to stdout as newline-delimited JSON (NDJSON), making it natively compatible with modern log aggregation platforms.","source":"@site/../docs/Structured-Logging.md","sourceDirName":".","slug":"/Structured-Logging","permalink":"/FileBridge/docs/Structured-Logging","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Audit Logging","permalink":"/FileBridge/docs/Audit-Logging"},"next":{"title":"API Reference","permalink":"/FileBridge/docs/API-Reference"}}');var i=r(4848),t=r(8453);const d={},l="Structured Logging",o={},c=[{value:"Log Format",id:"log-format",level:2},{value:"Standard Fields",id:"standard-fields",level:3},{value:"Context Fields (when present)",id:"context-fields-when-present",level:3},{value:"Log Levels",id:"log-levels",level:2},{value:"Sensitive Field Redaction",id:"sensitive-field-redaction",level:2},{value:"Context Propagation",id:"context-propagation",level:2},{value:"Request Context",id:"request-context",level:3},{value:"Job Context",id:"job-context",level:3},{value:"Component Loggers",id:"component-loggers",level:2},{value:"Development: Pretty-Printed Logs",id:"development-pretty-printed-logs",level:2},{value:"Production: Log Aggregation",id:"production-log-aggregation",level:2},{value:"Example: Docker Compose with Loki",id:"example-docker-compose-with-loki",level:3},{value:"Useful Queries (Loki LogQL)",id:"useful-queries-loki-logql",level:3},{value:"Correlating Logs with Audit Events",id:"correlating-logs-with-audit-events",level:2}];function h(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"structured-logging",children:"Structured Logging"})}),"\n",(0,i.jsxs)(n.p,{children:["FileBridge emits structured JSON logs using ",(0,i.jsx)(n.a,{href:"https://getpino.io",children:"pino"}),", a high-performance Node.js logger. All log output goes to ",(0,i.jsx)(n.strong,{children:"stdout"})," as newline-delimited JSON (NDJSON), making it natively compatible with modern log aggregation platforms."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"log-format",children:"Log Format"}),"\n",(0,i.jsx)(n.p,{children:"Each log line is a JSON object:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "level": 30,\n  "time": "2026-02-22T06:00:01.234Z",\n  "service": "filebridge",\n  "component": "engine",\n  "jobId": 7,\n  "runId": 42,\n  "msg": "File uploaded",\n  "fileName": "report_2026-02-22.csv",\n  "dstPath": "/archive/reports/report_2026-02-22.csv"\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"standard-fields",children:"Standard Fields"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Field"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"level"})}),(0,i.jsx)(n.td,{children:"Numeric pino level (10=trace, 20=debug, 30=info, 40=warn, 50=error, 60=fatal)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"time"})}),(0,i.jsx)(n.td,{children:"ISO 8601 timestamp"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"service"})}),(0,i.jsxs)(n.td,{children:["Always ",(0,i.jsx)(n.code,{children:'"filebridge"'})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"component"})}),(0,i.jsxs)(n.td,{children:["Source component: ",(0,i.jsx)(n.code,{children:"engine"}),", ",(0,i.jsx)(n.code,{children:"scheduler"}),", ",(0,i.jsx)(n.code,{children:"sftp"}),", ",(0,i.jsx)(n.code,{children:"smb"}),", ",(0,i.jsx)(n.code,{children:"azure-blob"}),", ",(0,i.jsx)(n.code,{children:"audit"}),", ",(0,i.jsx)(n.code,{children:"backup"}),", ",(0,i.jsx)(n.code,{children:"env"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"msg"})}),(0,i.jsx)(n.td,{children:"Human-readable message"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"context-fields-when-present",children:"Context Fields (when present)"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Field"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"requestId"})}),(0,i.jsxs)(n.td,{children:["UUID from ",(0,i.jsx)(n.code,{children:"X-Request-ID"})," header \u2014 correlates all logs for a single HTTP request"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"jobId"})}),(0,i.jsx)(n.td,{children:"Database ID of the job being executed"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"runId"})}),(0,i.jsx)(n.td,{children:"Database ID of the specific job run"})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"log-levels",children:"Log Levels"}),"\n",(0,i.jsxs)(n.p,{children:["Control verbosity with the ",(0,i.jsx)(n.code,{children:"LOG_LEVEL"})," environment variable:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Level"}),(0,i.jsx)(n.th,{children:"Value"}),(0,i.jsx)(n.th,{children:"When to use"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"trace"})}),(0,i.jsx)(n.td,{children:"10"}),(0,i.jsx)(n.td,{children:"Extremely verbose \u2014 internal library details"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"debug"})}),(0,i.jsx)(n.td,{children:"20"}),(0,i.jsx)(n.td,{children:"Development debugging (file lists, timing)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"info"})}),(0,i.jsx)(n.td,{children:"30"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.strong,{children:"Default"})," \u2014 normal operation events"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"warn"})}),(0,i.jsx)(n.td,{children:"40"}),(0,i.jsx)(n.td,{children:"Recoverable issues (backup failed, retry attempt)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"error"})}),(0,i.jsx)(n.td,{children:"50"}),(0,i.jsx)(n.td,{children:"Failures requiring attention"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"fatal"})}),(0,i.jsx)(n.td,{children:"60"}),(0,i.jsx)(n.td,{children:"Process-level failures before exit"})]})]})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-env",children:"LOG_LEVEL=debug   # development\nLOG_LEVEL=info    # production (default)\nLOG_LEVEL=warn    # production (minimal noise)\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"sensitive-field-redaction",children:"Sensitive Field Redaction"}),"\n",(0,i.jsxs)(n.p,{children:["The following fields are automatically redacted (",(0,i.jsx)(n.code,{children:"[REDACTED]"}),") from all log output, at any nesting level:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"password"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"privateKey"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"passphrase"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"accountKey"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"connectionString"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"token"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"secret"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"credentials"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This prevents credentials from appearing in log aggregation systems, even if a developer accidentally logs a connection object."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"context-propagation",children:"Context Propagation"}),"\n",(0,i.jsxs)(n.p,{children:["FileBridge uses Node.js ",(0,i.jsx)(n.code,{children:"AsyncLocalStorage"})," to automatically attach correlation context to all log lines within an async call chain \u2014 without threading parameters through every function signature."]}),"\n",(0,i.jsx)(n.h3,{id:"request-context",children:"Request Context"}),"\n",(0,i.jsxs)(n.p,{children:["API route handlers can wrap their logic with ",(0,i.jsx)(n.code,{children:"withRequestContext"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'import { withRequestContext } from "@/lib/logger";\n\nexport async function POST(req: Request) {\n  const requestId = req.headers.get("x-request-id") ?? crypto.randomUUID();\n  return withRequestContext(requestId, async () => {\n    // All log calls in here automatically include { requestId }\n    log.info("Handling request");\n  });\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The middleware automatically sets ",(0,i.jsx)(n.code,{children:"X-Request-ID"})," on every incoming request, so the ID is consistent across the full request lifecycle."]}),"\n",(0,i.jsx)(n.h3,{id:"job-context",children:"Job Context"}),"\n",(0,i.jsxs)(n.p,{children:["The transfer engine wraps each job execution with ",(0,i.jsx)(n.code,{children:"withJobContext"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'import { withJobContext } from "@/lib/logger";\n\nreturn withJobContext(jobId, run.id, async () => {\n  // All log calls from here, including storage providers, automatically include\n  // { jobId, runId } \u2014 no need to pass them as parameters\n  log.info("Connecting to source");\n  await source.connect(); // source.connect() also emits logs with jobId + runId\n});\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This means a single log query filtered by ",(0,i.jsx)(n.code,{children:"jobId = 7"})," and ",(0,i.jsx)(n.code,{children:"runId = 42"})," returns the complete story of that execution across every component."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"component-loggers",children:"Component Loggers"}),"\n",(0,i.jsx)(n.p,{children:"Each module creates its own named logger:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'import { createLogger } from "@/lib/logger";\nconst log = createLogger("engine");\n\nlog.info("Job started", { jobId: 42 });\nlog.warn("Retrying after error", { attempt: 2, error: err.message });\nlog.error("Job failed", { error: err });\n'})}),"\n",(0,i.jsx)(n.p,{children:"Components and their logger names:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Component"}),(0,i.jsx)(n.th,{children:"Name"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Transfer engine"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"engine"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Scheduler"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"scheduler"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"SFTP provider"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"sftp"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"SMB provider"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"smb"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Azure Blob provider"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"azure-blob"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Audit writer"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"audit"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Backup"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"backup"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Env validator"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"env"})})]})]})]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Note"}),": ",(0,i.jsx)(n.code,{children:"lib/auth/config.ts"})," intentionally uses ",(0,i.jsx)(n.code,{children:"console.*"})," instead of pino. The NextAuth config runs in the Edge runtime, which does not support the Node.js ",(0,i.jsx)(n.code,{children:"async_hooks"})," module that pino's context propagation depends on."]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"development-pretty-printed-logs",children:"Development: Pretty-Printed Logs"}),"\n",(0,i.jsxs)(n.p,{children:["In development, use the ",(0,i.jsx)(n.code,{children:"dev:pretty"})," script to pipe logs through ",(0,i.jsx)(n.code,{children:"pino-pretty"})," for colorized, human-readable output:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm run dev:pretty\n"})}),"\n",(0,i.jsx)(n.p,{children:"Example output:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"INFO  [engine]        Job started                         jobId=7\nINFO  [engine]        Source connected                    jobId=7 runId=42\nINFO  [engine]        File uploaded                       jobId=7 runId=42 fileName=report.csv\nINFO  [engine]        Job completed                       jobId=7 filesTransferred=12\n"})}),"\n",(0,i.jsx)(n.p,{children:"In production, use the raw JSON output and let your log platform handle formatting."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"production-log-aggregation",children:"Production: Log Aggregation"}),"\n",(0,i.jsx)(n.p,{children:"FileBridge's stdout NDJSON output is directly ingestable by:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Platform"}),(0,i.jsx)(n.th,{children:"How"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Datadog"})}),(0,i.jsxs)(n.td,{children:["Datadog Agent's ",(0,i.jsx)(n.code,{children:"logs"})," collection on stdout \u2014 zero config needed"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Grafana Loki"})}),(0,i.jsxs)(n.td,{children:["Promtail with ",(0,i.jsx)(n.code,{children:"pipeline_stages"})," parsing the JSON"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"AWS CloudWatch"})}),(0,i.jsxs)(n.td,{children:["CloudWatch Logs agent / ECS log driver (",(0,i.jsx)(n.code,{children:"awslogs"}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Azure Monitor"})}),(0,i.jsx)(n.td,{children:"Container Insights or Azure Log Analytics with the JSON parser"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Elastic (ELK)"})}),(0,i.jsx)(n.td,{children:"Filebeat with JSON log parsing"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Splunk"})}),(0,i.jsx)(n.td,{children:"Universal Forwarder with JSON source type"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"example-docker-compose-with-loki",children:"Example: Docker Compose with Loki"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'services:\n  filebridge:\n    image: filebridge:latest\n    logging:\n      driver: json-file\n      options:\n        max-size: "10m"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Then configure Promtail to scrape the Docker json-file log driver and parse the nested JSON ",(0,i.jsx)(n.code,{children:"log"})," field."]}),"\n",(0,i.jsx)(n.h3,{id:"useful-queries-loki-logql",children:"Useful Queries (Loki LogQL)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-logql",children:'# All errors for a specific job\n{service="filebridge"} | json | level="error" | jobId=7\n\n# All logs for a specific request\n{service="filebridge"} | json | requestId="abc-123"\n\n# SMB retry warnings\n{service="filebridge"} | json | component="smb" | level="warn"\n\n# Failed file transfers\n{service="filebridge"} | json | component="engine" | msg="Failed to transfer file"\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"correlating-logs-with-audit-events",children:"Correlating Logs with Audit Events"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"X-Request-ID"})," UUID ties structured log lines to audit events:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:['A user clicks "Run Now" in the UI \u2192 browser sends ',(0,i.jsx)(n.code,{children:"POST /api/jobs/7/run"})]}),"\n",(0,i.jsxs)(n.li,{children:["Middleware generates ",(0,i.jsx)(n.code,{children:"X-Request-ID: abc-123"})," and sets it on the response"]}),"\n",(0,i.jsxs)(n.li,{children:["The API handler uses ",(0,i.jsx)(n.code,{children:'withRequestContext("abc-123", ...)'})," so all its log lines include ",(0,i.jsx)(n.code,{children:'requestId: "abc-123"'})]}),"\n",(0,i.jsx)(n.li,{children:"The audit log entry for the execution contains the userId and action"}),"\n",(0,i.jsxs)(n.li,{children:["Structured logs with ",(0,i.jsx)(n.code,{children:'requestId: "abc-123"'})," contain the full execution detail"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Search for ",(0,i.jsx)(n.code,{children:'requestId: "abc-123"'})," in your log platform to get the complete picture."]})]})}function a(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},8453(e,n,r){r.d(n,{R:()=>d,x:()=>l});var s=r(6540);const i={},t=s.createContext(i);function d(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);