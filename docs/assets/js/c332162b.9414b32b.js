"use strict";(self.webpackChunkfilebridge_docs=self.webpackChunkfilebridge_docs||[]).push([[435],{8931(e,n,t){t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"Extending-FileBridge","title":"Extending FileBridge","description":"FileBridge is designed with extensibility as a first-class concern. Adding new storage protocols, post-transfer actions, or notification channels requires changes to a small number of focused files and no modifications to the core transfer engine or scheduler.","source":"@site/../docs/Extending-FileBridge.md","sourceDirName":".","slug":"/Extending-FileBridge","permalink":"/FileBridge/docs/Extending-FileBridge","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Security","permalink":"/FileBridge/docs/Security"}}');var r=t(4848),s=t(8453);const o={},d="Extending FileBridge",a={},c=[{value:"Adding a New Storage Provider",id:"adding-a-new-storage-provider",level:2},{value:"Step 1 \u2014 Create the Provider Class",id:"step-1--create-the-provider-class",level:3},{value:"Step 2 \u2014 Register the Provider",id:"step-2--register-the-provider",level:3},{value:"Step 3 \u2014 Add the Protocol to the DB Schema",id:"step-3--add-the-protocol-to-the-db-schema",level:3},{value:"Step 4 \u2014 Update the Connection Form UI",id:"step-4--update-the-connection-form-ui",level:3},{value:"Step 5 \u2014 Add to next.config.ts (if needed)",id:"step-5--add-to-nextconfigts-if-needed",level:3},{value:"That&#39;s It",id:"thats-it",level:3},{value:"Adding a New Post-Transfer Action",id:"adding-a-new-post-transfer-action",level:2},{value:"Step 1 \u2014 Extend the Schema Enum",id:"step-1--extend-the-schema-enum",level:3},{value:"Step 2 \u2014 Handle It in the Engine",id:"step-2--handle-it-in-the-engine",level:3},{value:"Step 3 \u2014 Add the Option to the Job Form",id:"step-3--add-the-option-to-the-job-form",level:3},{value:"Adding a New Notification Channel",id:"adding-a-new-notification-channel",level:2},{value:"Step 1 \u2014 Extend the Settings Schema",id:"step-1--extend-the-settings-schema",level:3},{value:"Step 2 \u2014 Add the UI Tab",id:"step-2--add-the-ui-tab",level:3},{value:"Step 3 \u2014 Wire Up Dispatch",id:"step-3--wire-up-dispatch",level:3},{value:"Adding a New Dashboard Widget",id:"adding-a-new-dashboard-widget",level:2},{value:"Contributing Patterns",id:"contributing-patterns",level:2},{value:"Logging",id:"logging",level:3},{value:"Audit Logging",id:"audit-logging",level:3},{value:"API Route Pattern",id:"api-route-pattern",level:3}];function l(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"extending-filebridge",children:"Extending FileBridge"})}),"\n",(0,r.jsx)(n.p,{children:"FileBridge is designed with extensibility as a first-class concern. Adding new storage protocols, post-transfer actions, or notification channels requires changes to a small number of focused files and no modifications to the core transfer engine or scheduler."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"adding-a-new-storage-provider",children:"Adding a New Storage Provider"}),"\n",(0,r.jsxs)(n.p,{children:["A storage provider implements the ",(0,r.jsx)(n.code,{children:"StorageProvider"})," interface defined in ",(0,r.jsx)(n.code,{children:"lib/storage/interface.ts"}),". Once implemented, it integrates automatically with the transfer engine, file browser, connection testing, and dry-run system."]}),"\n",(0,r.jsx)(n.h3,{id:"step-1--create-the-provider-class",children:"Step 1 \u2014 Create the Provider Class"}),"\n",(0,r.jsxs)(n.p,{children:["Create ",(0,r.jsx)(n.code,{children:"lib/storage/s3.ts"})," (or ",(0,r.jsx)(n.code,{children:"ftp.ts"}),", ",(0,r.jsx)(n.code,{children:"gcs.ts"}),", etc.):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'import { StorageProvider, FileInfo } from "./interface";\n\ninterface S3Credentials {\n  accessKeyId: string;\n  secretAccessKey: string;\n  region: string;\n  bucket: string;\n}\n\nexport class S3Provider implements StorageProvider {\n  private client: S3Client; // e.g. @aws-sdk/client-s3\n\n  constructor(private credentials: S3Credentials) {}\n\n  async connect(): Promise<void> {\n    this.client = new S3Client({\n      region: this.credentials.region,\n      credentials: {\n        accessKeyId: this.credentials.accessKeyId,\n        secretAccessKey: this.credentials.secretAccessKey,\n      },\n    });\n  }\n\n  async disconnect(): Promise<void> {\n    // S3 client is stateless \u2014 nothing to close\n  }\n\n  async listFiles(path: string, filter?: string): Promise<FileInfo[]> {\n    // List objects with the given prefix\n    // Apply glob filter using globToRegex from interface.ts\n    // Return FileInfo[] with name, size, modifiedAt, isDirectory: false\n  }\n\n  async listDirectory(path: string): Promise<FileInfo[]> {\n    // Like listFiles but also include "directory" prefixes\n  }\n\n  async downloadFile(remotePath: string): Promise<Buffer> {\n    // GetObjectCommand \u2192 collect stream \u2192 return Buffer\n  }\n\n  async uploadFile(content: Buffer, remotePath: string): Promise<void> {\n    // PutObjectCommand\n  }\n\n  async deleteFile(remotePath: string): Promise<void> {\n    // DeleteObjectCommand\n  }\n\n  async moveFile(sourcePath: string, destinationPath: string): Promise<void> {\n    // CopyObjectCommand + DeleteObjectCommand (or server-side copy)\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"step-2--register-the-provider",children:"Step 2 \u2014 Register the Provider"}),"\n",(0,r.jsxs)(n.p,{children:["Add a case in ",(0,r.jsx)(n.code,{children:"lib/storage/registry.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'import { S3Provider } from "./s3";\n\nexport function createStorageProvider(connection: Connection): StorageProvider {\n  switch (connection.protocol) {\n    case "sftp":   return new SftpProvider(connection);\n    case "smb":    return new SmbProvider(connection);\n    case "azure-blob": return new AzureBlobProvider(connection);\n    case "s3":     return new S3Provider(connection.credentials as S3Credentials); // add this\n    default:\n      throw new Error(`Unknown protocol: ${connection.protocol}`);\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"step-3--add-the-protocol-to-the-db-schema",children:"Step 3 \u2014 Add the Protocol to the DB Schema"}),"\n",(0,r.jsxs)(n.p,{children:["In ",(0,r.jsx)(n.code,{children:"lib/db/schema.ts"}),", extend the ",(0,r.jsx)(n.code,{children:"protocol"})," enum:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'protocol: text("protocol", {\n  enum: ["sftp", "smb", "azure-blob", "s3"]  // add "s3"\n}).notNull(),\n'})}),"\n",(0,r.jsx)(n.h3,{id:"step-4--update-the-connection-form-ui",children:"Step 4 \u2014 Update the Connection Form UI"}),"\n",(0,r.jsxs)(n.p,{children:["In ",(0,r.jsx)(n.code,{children:"components/connections/connection-form.tsx"}),":"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Add ",(0,r.jsx)(n.code,{children:'"s3"'})," to the protocol selector options"]}),"\n",(0,r.jsx)(n.li,{children:"Add credential fields for the new protocol (conditionally rendered based on selected protocol)"}),"\n",(0,r.jsxs)(n.li,{children:["Map the form fields to the ",(0,r.jsx)(n.code,{children:"credentials"})," JSON object"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-5--add-to-nextconfigts-if-needed",children:"Step 5 \u2014 Add to next.config.ts (if needed)"}),"\n",(0,r.jsxs)(n.p,{children:["If the new provider uses a native Node.js module, add it to ",(0,r.jsx)(n.code,{children:"serverExternalPackages"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'// next.config.ts\nserverExternalPackages: ["better-sqlite3", "ssh2-sftp-client", "v9u-smb2", "@aws-sdk/client-s3"]\n'})}),"\n",(0,r.jsx)(n.h3,{id:"thats-it",children:"That's It"}),"\n",(0,r.jsx)(n.p,{children:"The transfer engine, scheduler, dry-run system, connection tester, and file browser all work with the new provider automatically \u2014 no changes required in any of those files."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"adding-a-new-post-transfer-action",children:"Adding a New Post-Transfer Action"}),"\n",(0,r.jsx)(n.p,{children:"Post-transfer actions control what happens to the source file after a successful transfer."}),"\n",(0,r.jsx)(n.h3,{id:"step-1--extend-the-schema-enum",children:"Step 1 \u2014 Extend the Schema Enum"}),"\n",(0,r.jsxs)(n.p,{children:["In ",(0,r.jsx)(n.code,{children:"lib/db/schema.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'postTransferAction: text("post_transfer_action", {\n  enum: ["retain", "delete", "move", "archive"]  // add "archive"\n}).notNull().default("retain"),\n'})}),"\n",(0,r.jsx)(n.h3,{id:"step-2--handle-it-in-the-engine",children:"Step 2 \u2014 Handle It in the Engine"}),"\n",(0,r.jsxs)(n.p,{children:["In ",(0,r.jsx)(n.code,{children:"lib/transfer/engine.ts"}),", find the post-transfer action block and add a case:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'if (job.postTransferAction === "delete") {\n  await source.deleteFile(srcFilePath);\n} else if (job.postTransferAction === "move" && job.movePath) {\n  await source.moveFile(srcFilePath, path.posix.join(job.movePath, file.name));\n} else if (job.postTransferAction === "archive") {\n  // your custom logic here\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"step-3--add-the-option-to-the-job-form",children:"Step 3 \u2014 Add the Option to the Job Form"}),"\n",(0,r.jsxs)(n.p,{children:["In ",(0,r.jsx)(n.code,{children:"components/jobs/job-form.tsx"}),", add the new action to the select field options."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"adding-a-new-notification-channel",children:"Adding a New Notification Channel"}),"\n",(0,r.jsxs)(n.p,{children:["The settings system uses a flexible key-value store. Notification settings are stored as JSON under the ",(0,r.jsx)(n.code,{children:'"notifications"'})," key."]}),"\n",(0,r.jsx)(n.h3,{id:"step-1--extend-the-settings-schema",children:"Step 1 \u2014 Extend the Settings Schema"}),"\n",(0,r.jsxs)(n.p,{children:["In ",(0,r.jsx)(n.code,{children:"app/api/settings/route.ts"}),", add your new channel's fields to the settings object being read and written."]}),"\n",(0,r.jsx)(n.h3,{id:"step-2--add-the-ui-tab",children:"Step 2 \u2014 Add the UI Tab"}),"\n",(0,r.jsxs)(n.p,{children:["In ",(0,r.jsx)(n.code,{children:"components/settings/notification-settings.tsx"}),", add a new tab or section for the new channel (e.g. Slack webhook, PagerDuty API key)."]}),"\n",(0,r.jsx)(n.h3,{id:"step-3--wire-up-dispatch",children:"Step 3 \u2014 Wire Up Dispatch"}),"\n",(0,r.jsxs)(n.p,{children:["In the transfer engine (",(0,r.jsx)(n.code,{children:"lib/transfer/engine.ts"}),"), in the error handling block, read the notification settings and trigger your new channel. A ",(0,r.jsx)(n.code,{children:"sendNotification(channel, message)"})," abstraction would be a natural place to put this logic."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"adding-a-new-dashboard-widget",children:"Adding a New Dashboard Widget"}),"\n",(0,r.jsxs)(n.p,{children:["The dashboard data is served from ",(0,r.jsx)(n.code,{children:"app/api/dashboard/stats/route.ts"}),". To add a new KPI:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Add the query to the stats API route"}),"\n",(0,r.jsx)(n.li,{children:"Add the new field to the response JSON"}),"\n",(0,r.jsxs)(n.li,{children:["Create a new card component in ",(0,r.jsx)(n.code,{children:"components/dashboard/"})]}),"\n",(0,r.jsx)(n.li,{children:"Add it to the dashboard page layout"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"contributing-patterns",children:"Contributing Patterns"}),"\n",(0,r.jsx)(n.p,{children:"When adding new features, follow these conventions used throughout the codebase:"}),"\n",(0,r.jsx)(n.h3,{id:"logging",children:"Logging"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'import { createLogger } from "@/lib/logger";\nconst log = createLogger("my-component");\n\nlog.info("Something happened", { key: "value" });\nlog.error("Something failed", { error: err });\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Never use ",(0,r.jsx)(n.code,{children:"console.log"})," in server-side code (except in ",(0,r.jsx)(n.code,{children:"lib/auth/config.ts"})," which runs in the Edge runtime)."]}),"\n",(0,r.jsx)(n.h3,{id:"audit-logging",children:"Audit Logging"}),"\n",(0,r.jsx)(n.p,{children:"For any action that creates, modifies, or deletes user data:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'import { logAudit, getIpFromRequest, getUserId } from "@/lib/audit";\n\nawait logAudit({\n  userId: getUserId(session),\n  action: "create",\n  resource: "connection",\n  resourceId: newConnection.id,\n  resourceName: newConnection.name,\n  ipAddress: getIpFromRequest(request),\n  details: { protocol: newConnection.protocol },\n});\n'})}),"\n",(0,r.jsx)(n.h3,{id:"api-route-pattern",children:"API Route Pattern"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'import { auth } from "@/lib/auth";\nimport { db } from "@/lib/db";\nimport { NextResponse } from "next/server";\n\nexport async function GET(request: Request) {\n  const session = await auth();\n  if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });\n\n  try {\n    const data = await db.query.myTable.findMany();\n    return NextResponse.json(data);\n  } catch (err) {\n    log.error("Failed to fetch data", { error: err });\n    return NextResponse.json({ error: "Internal server error" }, { status: 500 });\n  }\n}\n'})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},8453(e,n,t){t.d(n,{R:()=>o,x:()=>d});var i=t(6540);const r={},s=i.createContext(r);function o(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);